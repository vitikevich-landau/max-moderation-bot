# Max Moderation Bot

Бот модерации для MAX (Telegram-совместимый). Автоматически фильтрует нежелательный контент в групповых чатах.

## Возможности

- Фильтрация запрещённых слов и доменов
- Автоматическая настройка при добавлении в чат
- Встроенные словари модерации (~870 слов, ~10 доменов)
- Управление через inline-меню прямо в чате
- Мьют нарушителей с настраиваемыми порогами и длительностью
- Глобальные списки слов и доменов (действуют на все чаты)
- Настраиваемый часовой пояс
- Уведомления замьюченным пользователям
- Redis-кэширование для высокой нагрузки
- Масштабируемость: worker pool, connection pooling, rate limiting

## Быстрый старт

### Linux (Ubuntu / Debian)

```bash
git clone https://github.com/vitikevich-landau/max-moderation-bot.git
cd max-moderation-bot
chmod +x install-linux.sh
./install-linux.sh ТВОЙ_ТОКЕН_БОТА
```

Скрипт автоматически установит Docker если его нет.

### Windows

**Требуется:** [Docker Desktop](https://docs.docker.com/desktop/install/windows-install/)

**PowerShell:**
```powershell
git clone https://github.com/vitikevich-landau/max-moderation-bot.git
cd max-moderation-bot
.\install-windows.ps1 ТВОЙ_ТОКЕН_БОТА
```

**CMD (bat):**
```cmd
git clone https://github.com/vitikevich-landau/max-moderation-bot.git
cd max-moderation-bot
install-windows.bat ТВОЙ_ТОКЕН_БОТА
```

## Настройка владельца бота

После первого запуска рекомендуется указать владельца бота. Это даёт доступ к глобальным настройкам и управлению всеми чатами.

### Шаг 1 — Узнать свой ID

Напишите боту в личные сообщения команду:

```
/myid
```

Бот ответит вашим числовым ID (например `123456789`).

### Шаг 2 — Прописать ID в конфигурации

Откройте (или создайте) файл `prod.env` в папке с ботом и добавьте строку:

```
BOT_OWNER_ID=123456789
```

### Шаг 3 — Перезапустить бота

```bash
docker compose up -d
```

После перезапуска в главном меню появится кнопка **"Глобальные настройки"**, а в разделе **"Мои группы"** вы увидите все подключённые чаты.

### Возможности владельца

| Функция | Описание |
|---------|----------|
| Глобальные слова | Запрещённые слова, действующие во **всех** чатах |
| Глобальные домены | Заблокированные домены, действующие во **всех** чатах |
| Часовой пояс | Выбор часового пояса для отображения времени (UTC+2 — UTC+12) |
| Все чаты | Владелец видит и управляет всеми подключёнными чатами |

## Архитектура

Бот разворачивается в трёх контейнерах:
- **Bot** — основной сервис (Go, готовый Docker-образ из GHCR)
- **PostgreSQL** — база данных (настройки чатов, мьюты, статистика)
- **Redis** — кэш настроек и распределённый rate limiting

## Как работает

1. Запускаете скрипт с токеном бота
2. Добавляете бота в чат
3. Назначаете бота администратором
4. Готово — бот модерирует
5. (Опционально) Настраиваете `BOT_OWNER_ID` для глобального управления

## Управление

| Команда | Описание |
|---------|----------|
| `docker logs -f maxbot-bot` | Логи бота |
| `docker compose ps` | Статус контейнеров |
| `docker compose down` | Остановить бота |
| `docker compose pull && docker compose up -d` | Обновить до последней версии |

## Переменные окружения

Основные настройки задаются через `prod.env` (переопределяет `default.env`):

| Переменная | По умолчанию | Описание |
|------------|-------------|----------|
| `BOT_TOKEN` | — | Токен бота (обязательно) |
| `BOT_OWNER_ID` | `0` | ID владельца бота для доступа к глобальным настройкам |
| `TZ` | `Europe/Moscow` | Часовой пояс по умолчанию (можно изменить через меню) |
| `DEFAULT_MUTE_DURATION` | `30m` | Длительность мута по умолчанию |
| `MAX_IMPORT_FILE_SIZE` | `102400` | Максимальный размер импортируемого TXT файла (байт) |
| `LOG_LEVEL` | `info` | Уровень логирования (`debug`, `info`, `warn`, `error`) |
| `REDIS_URL` | `redis://redis:6379/0` | Адрес Redis (используется для кэша и rate limiting) |
| `WORKER_COUNT` | `0` (авто) | Количество воркеров обработки сообщений (0 = CPU * 2) |
| `DB_MAX_OPEN_CONNS` | `25` | Максимум открытых соединений к БД |
| `DB_MAX_IDLE_CONNS` | `10` | Максимум idle-соединений к БД |
| `UPDATE_BUFFER_SIZE` | `10000` | Размер буфера входящих сообщений |
| `MAX_BACKGROUND_WORKERS` | `1000` | Лимит фоновых горутин |

## Фильтры по умолчанию

При добавлении бота в чат автоматически загружаются встроенные фильтры:

| Файл | Описание | Количество |
|------|----------|------------|
| [`filters/blocked_words.txt`](filters/blocked_words.txt) | Запрещённые слова (мат, спам) | ~870 |
| [`filters/blocked_domains.txt`](filters/blocked_domains.txt) | Заблокированные домены (сокращатели ссылок) | 10 |

### Как дополнить фильтры

Через меню бота в личных сообщениях:

- **Вручную** — кнопка "Добавить слова/домены" → ввести через запятую
- **Файлом** — кнопка "Импорт из TXT" → отправить .txt файл (одно слово на строку)

Импорт **дополняет** текущие фильтры, а не заменяет их. Дубликаты отсеиваются автоматически.

### Как подготовить свой файл фильтров

1. Скачайте файл из папки `filters/` как основу
2. Добавьте или удалите строки (одно слово/домен на строку)
3. Загрузите через бота кнопкой "Импорт из TXT"

### Как очистить фильтры

В меню бота → "Очистить слова" / "Очистить домены" — сбрасывает все фильтры.

## Получение токена

Создайте бота через BotFather и скопируйте токен.
